{% extends 'base.html' %} {% load static %} {% block title %}Estad√≠sticas -
Biblioteca UTH{% endblock %} {% block content %}
<div class="container mt-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìä Estad√≠sticas del Sistema</h1>
    <span class="text-muted">Resumen general de la biblioteca</span>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-book-open me-2"></i>Libros por Categor√≠a
          </h5>
        </div>
        <div class="card-body d-flex justify-content-center align-items-center">
          <div style="height: 300px; width: 100%; position: relative">
            <canvas id="chart-categorias"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-user-tag me-2"></i>Top Autores Populares
          </h5>
        </div>
        <div class="card-body">
          <div style="height: 300px; width: 100%; position: relative">
            <canvas id="chart-autores"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">üìã Detalle de Autores M√°s Prestados</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Autor</th>
                  <th>Nacionalidad</th>
                  <th class="text-center">Total Pr√©stamos</th>
                </tr>
              </thead>
              <tbody>
                {% for autor in top_autores %}
                <tr>
                  <td class="align-middle fw-bold">
                    {{ autor.nombre }} {{ autor.apellido }}
                  </td>
                  <td class="align-middle">{{ autor.nacionalidad }}</td>
                  <td class="text-center align-middle">
                    <span class="badge rounded-pill bg-primary fs-6">
                      {{ autor.total_prestamos }}
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br />
                    No hay datos de pr√©stamos registrados a√∫n.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {

      // --- GR√ÅFICO 1: CATEGOR√çAS ---
      const ctxCat = document.getElementById('chart-categorias').getContext('2d');
      const catLabels = [{% for c in libros_por_categoria %}"{{ c.nombre }}",{% endfor %}];
      const catData = [{% for c in libros_por_categoria %}{{ c.total }},{% endfor %}];

      new Chart(ctxCat, {
          type: 'doughnut',
          data: {
              labels: catLabels,
              datasets: [{
                  label: 'Cantidad de Libros',
                  data: catData,
                  backgroundColor: [
                      '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                  ],
                  hoverOffset: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false, // ¬°IMPORTANTE: Permite ajustar al div padre!
              plugins: {
                  legend: {
                      position: 'right', // Pone la leyenda a la derecha para ahorrar altura
                      labels: { padding: 20, boxWidth: 12 }
                  }
              },
              layout: {
                  padding: 10
              }
          }
      });

      // --- GR√ÅFICO 2: AUTORES ---
      const ctxAut = document.getElementById('chart-autores').getContext('2d');
      const autLabels = [{% for a in top_autores %}"{{ a.nombre }} {{ a.apellido }}",{% endfor %}];
      const autData = [{% for a in top_autores %}{{ a.total_prestamos }},{% endfor %}];

      new Chart(ctxAut, {
          type: 'bar',
          data: {
              labels: autLabels,
              datasets: [{
                  label: 'Pr√©stamos Totales',
                  data: autData,
                  backgroundColor: '#1cc88a',
                  borderColor: '#17a673',
                  borderWidth: 1,
                  borderRadius: 4 // Bordes redondeados en las barras
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false, // ¬°IMPORTANTE: Permite ajustar al div padre!
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: { stepSize: 1 },
                      grid: { borderDash: [2] } // L√≠neas punteadas para estilo m√°s limpio
                  },
                  x: {
                      grid: { display: false } // Oculta l√≠neas verticales
                  }
              },
              plugins: {
                  legend: { display: false } // Ocultamos leyenda porque ya dice el t√≠tulo
              }
          }
      });
  });
</script>
{% endblock %}
